<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>フラッグマン風ゲーム</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      touch-action: none;
      background: #f0f0f0;
      font-family: sans-serif;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    #game {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 30px;
      margin: 20px;
    }

    .flag-button {
      font-size: 60px;
      width: 400px;
      height: 400px;
      border-radius: 30px;
      background-color: #ddd;
      border: 4px solid #999;
      transition: background-color 0.2s;
    }

    .flag-button.active {
      background-color: yellow;
    }

    #startBtn {
      font-size: 28px;
      padding: 14px 36px;
      margin-top: 10px;
    }

    #score {
      font-size: 28px;
      margin-top: 10px;
      color: #333;
    }

    #message {
      font-size: 24px;
      margin-top: 10px;
      height: 30px;
    }
  </style>
</head>
<body>
  <h1>フラッグマン風ゲーム</h1>
  <div id="game">
    <div id="buttons">
      <button class="flag-button" data-num="1">1</button>
      <button class="flag-button" data-num="2">2</button>
      <button class="flag-button" data-num="3">3</button>
      <button class="flag-button" data-num="4">4</button>
    </div>
    <button id="startBtn">スタート</button>
    <div id="score">スコア: 0</div>
    <div id="message"></div>
  </div>

  <script>
    const sequence = [];
    let playerInput = [];
    let round = 0;
    let inputEnabled = false;

    const buttons = document.querySelectorAll('.flag-button');
    const startBtn = document.getElementById('startBtn');
    const message = document.getElementById('message');
    const scoreDisplay = document.getElementById('score');

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const tones = [440, 550, 660, 880];

    const vibrationPatterns = [
      [100],
      [200],
      [100, 50, 100],
      [300]
    ];

    startBtn.addEventListener('click', startGame);

    buttons.forEach(button => {
      button.addEventListener('click', () => handlePlayerInput(button.dataset.num));
    });

    function startGame() {
      round = 0;
      sequence.length = 0;
      message.textContent = '';
      scoreDisplay.textContent = 'スコア: 0';
      nextRound();
    }

    function nextRound() {
      round++;
      playerInput = [];
      const nextNum = Math.floor(Math.random() * 4) + 1;
      sequence.push(nextNum);
      message.textContent = `ラウンド ${round}`;
      scoreDisplay.textContent = `スコア: ${round - 1}`;
      showSequence();
    }

    function showSequence() {
      inputEnabled = false;
      let i = 0;
      const interval = setInterval(() => {
        if (i >= sequence.length) {
          clearInterval(interval);
          inputEnabled = true;
          return;
        }
        const num = sequence[i];
        playFeedback(num);
        i++;
      }, 1000);
    }

    function playFeedback(num) {
      const button = document.querySelector(`.flag-button[data-num="${num}"]`);
      button.classList.add('active');
      playTone(tones[num - 1]);

      if (navigator.vibrate) {
        navigator.vibrate(vibrationPatterns[num - 1]);
      }

      setTimeout(() => {
        button.classList.remove('active');
      }, 500);
    }

    function playTone(freq, duration = 200) {
      const oscillator = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      oscillator.frequency.value = freq;
      oscillator.type = 'square';

      oscillator.connect(gain);
      gain.connect(audioCtx.destination);

      oscillator.start();
      gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + duration / 1000);
    }

    function handlePlayerInput(num) {
      if (!inputEnabled) return;

      const numInt = Number(num);
      playerInput.push(numInt);
      playFeedback(numInt);

      const currentIndex = playerInput.length - 1;

      if (playerInput[currentIndex] !== sequence[currentIndex]) {
        message.textContent = 'ミス！ゲームオーバー';
        scoreDisplay.textContent = `最終スコア: ${round - 1}`;
        inputEnabled = false;
        return;
      }

      if (playerInput.length === sequence.length) {
        setTimeout(() => nextRound(), 1000);
      }
    }
  </script>
</body>
</html>